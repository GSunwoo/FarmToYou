<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.farm.service.IProductService">
	<insert id="productWrite"
		parameterType="com.farm.dto.ProductDTO">
		<selectKey keyProperty="prod_id" resultType="long"
			order="BEFORE">
			SELECT seq_product_id.nextval FROM dual
		</selectKey>

		INSERT INTO product
		(prod_price, prod_stock, member_id, prod_id,
		prod_cate, prod_content, prod_name )
		VALUES
		(#{prod_price},
		#{prod_stock}, #{member_id}, #{prod_id}, #{prod_cate},
		#{prod_content}, #{prod_name})
	</insert>

	<select id="getTotalCount" resultType="int"
		parameterType="com.farm.dto.ParameterDTO">

		SELECT COUNT(*) FROM product

		<!-- 검색어가 있는 경우에만 where절을 조건부로 추가한다. -->
		<if test="searchWord!=null and 
			!searchWord.equals('')">
			WHERE prod_name LIKE '%' || #{searchWord} || '%'
		</if>
	</select>



	<select id="selectProduct"
		parameterType="com.farm.dto.ParameterDTO"
		resultType="com.farm.dto.ProductDTO">
		SELECT prod_price, prod_stock, member_id, pro.prod_id, prod_cate,
		prod_content, prod_name, filename
		FROM (SELECT Tb.*, rownum rNum FROM (
		SELECT * FROM product
		<if test="searchWords != null and !searchWords.equals('') ">
			WHERE
			<foreach collection="searchWords" item="sw" separator="or"
				open="(" close=")">
				prod_name LIKE '%' || #{sw} || '%'
			</foreach>
		</if>
		ORDER BY prod_id DESC
		) Tb
		WHERE rownum<![CDATA[<=]]>#{end}
		) pro
		LEFT JOIN product_img img
		ON pro.prod_id = img.prod_id and
		img.main_idx = 1
		WHERE rNum <![CDATA[>=]]>#{start}
	</select>

	<select id="selectBestProd"
		parameterType="com.farm.dto.ParameterDTO"
		resultType="com.farm.dto.ProductDTO">
		SELECT prod_price, pro.prod_id, prod_cate, prod_name, filename
		FROM (
		    SELECT Tb.*, rownum rNum 
		    FROM (
		        SELECT pr.prod_price, pr.prod_id, pr.prod_cate, pr.prod_name
		        FROM product pr
		        JOIN purchase pu ON pr.prod_id = pu.prod_id
		
		        <if test="searchWords != null and !searchWords.equals('') ">
		            WHERE
		            <foreach collection="searchWords" item="sw" separator="or" open="(" close=")">
		                pr.prod_name LIKE '%' || #{sw} || '%'
		            </foreach>
		        </if>
		
		        GROUP BY pr.prod_price, pr.prod_id, pr.prod_cate, pr.prod_name
		        ORDER BY COUNT(pu.prod_id) DESC
		    ) Tb
		    WHERE rownum <![CDATA[<=]]> #{end}
		) pro
		LEFT JOIN product_img img 
		    ON pro.prod_id = img.prod_id AND img.main_idx = 1
		WHERE rNum <![CDATA[>=]]> #{start}
	</select>

	<select id="selectBestProdForLastWeek" parameterType="Long"
		resultType="com.farm.dto.ProductDTO">
		SELECT prod_id, prod_price, prod_name, filename
		FROM (SELECT
		pr.prod_id,
		pr.prod_price,
		pr.prod_name,
		pi.filename,
		ROW_NUMBER() OVER (ORDER BY COUNT(pu.prod_id) DESC) rNum
		FROM product pr
		JOIN purchase pu ON pr.prod_id = pu.prod_id
		JOIN product_img pi ON pr.prod_id = pi.prod_id AND pi.main_idx = 1
		WHERE pu.purc_date >= TRUNC(SYSDATE) - 6
		GROUP BY pr.prod_id, pr.prod_price, pr.prod_name, pi.filename
		)
		WHERE rNum <![CDATA[<=]]>
		#{end}
	</select>


	<select id="selectProductView" parameterType="Long"
		resultType="com.farm.dto.ProductDTO">
		SELECT prod_price, prod_stock, member_id, prod_id,
		prod_cate, prod_content, prod_name
		FROM product
		WHERE prod_id =
		#{prod_id}
	</select>

	<!-- 나의상품목록 조회 -->
	<select id="selectMyprod" parameterType="Long"
		resultType="com.farm.dto.ProductDTO">
		SELECT prod_price, prod_stock, member_id, prod_id,
		prod_cate, prod_content, prod_name
		FROM product
		WHERE member_id =
		${member_id}
	</select>

	<update id="productUpdate"
		parameterType="com.farm.dto.ProductDTO">
		UPDATE product set
		prod_price = #{prod_price},
		prod_stock
		= #{prod_stock},
		prod_cate = #{prod_cate},
		prod_content =
		#{prod_content},
		prod_name = #{prod_name}
		WHERE prod_id = #{prod_id}
	</update>

	<delete id="productDelete" parameterType="Long">
		DELETE FROM product
		WHERE prod_id = #{prod_id}
	</delete>


</mapper>
   